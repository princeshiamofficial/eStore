<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{SITE_TITLE}}</title>
    <meta name="description" content="{{SITE_DESCRIPTION}}">
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{OG_URL}}">
    <meta property="og:title" content="{{SITE_TITLE}}">
    <meta property="og:description" content="{{SITE_DESCRIPTION}}">
    <meta property="og:image" content="{{OG_IMAGE}}">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{OG_URL}}">
    <meta property="twitter:title" content="{{SITE_TITLE}}">
    <meta property="twitter:description" content="{{SITE_DESCRIPTION}}">
    <meta property="twitter:image" content="{{OG_IMAGE}}">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #ffffff;
            color: #0f172a;
        }

        img,
        video {
            -webkit-user-drag: none;
            user-select: none;
            pointer-events: none;
            /* Block extension detectors */
        }

        .blog-card {
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .blog-card:hover {
            transform: translateY(-8px);
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        .shimmer-sweep {
            position: relative;
            overflow: hidden;
            background: #f1f5f9;
        }

        .shimmer-sweep::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    rgba(255, 255, 255, 0) 100%);
            transform: translateX(-100%);
            animation: shimmer-sweep-anim 1.5s infinite;
        }

        .shimmer-sweep.loaded::after {
            display: none;
        }

        @keyframes shimmer-sweep-anim {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        .gradient-text {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body class="selection:bg-orange-100 selection:text-orange-900">

    <!-- Simple Navigation -->
    <nav
        class="fixed top-0 w-full z-50 bg-white/80 backdrop-blur-md border-b border-slate-100 px-6 md:px-12 py-4 flex items-center justify-between">
        <a href="/" class="flex items-center gap-2">
            <img src="/logo.png" alt="Color Hut" class="h-8">
        </a>
        <div class="hidden md:flex items-center gap-8">
            <a href="/"
                class="text-sm font-bold uppercase tracking-widest text-slate-500 hover:text-orange-500 transition-colors">Home</a>
            <a href="/all"
                class="text-sm font-bold uppercase tracking-widest text-slate-500 hover:text-orange-500 transition-colors">Collections</a>
            <a href="/blog" class="text-sm font-bold uppercase tracking-widest text-orange-600">Blog</a>
        </div>
    </nav>

    <main class="pt-32 pb-24 px-6 md:px-12 max-w-7xl mx-auto">
        <!-- Hero Section -->
        <div class="mb-20 text-center">
            <h1 class="text-5xl md:text-7xl font-black gradient-text tracking-tighter mb-6">Perspective</h1>
            <p class="text-slate-500 text-lg md:text-xl font-medium max-w-2xl mx-auto uppercase tracking-wide">
                Cornerstone insights on branding, corporate strategy, and the art of physical design.</p>
        </div>

        <!-- Blog Grid -->
        <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
            <!-- Skeleton Loading -->
            <div class="animate-pulse space-y-4">
                <div class="aspect-video bg-slate-100 rounded-[2rem]"></div>
                <div class="h-6 bg-slate-100 rounded-full w-3/4"></div>
                <div class="h-4 bg-slate-50 rounded-full w-full"></div>
            </div>
            <div class="animate-pulse space-y-4">
                <div class="aspect-video bg-slate-100 rounded-[2rem]"></div>
                <div class="h-6 bg-slate-100 rounded-full w-3/4"></div>
                <div class="h-4 bg-slate-50 rounded-full w-full"></div>
            </div>
            <div class="animate-pulse space-y-4">
                <div class="aspect-video bg-slate-100 rounded-[2rem]"></div>
                <div class="h-6 bg-slate-100 rounded-full w-3/4"></div>
                <div class="h-4 bg-slate-50 rounded-full w-full"></div>
            </div>
        </div>
    </main>

    <footer class="bg-slate-50 py-20 px-6 md:px-12 border-t border-slate-100">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-10">
            <div class="text-center md:text-left">
                <img src="/logo.png" alt="Color Hut" class="h-6 mb-4 opacity-50 grayscale mx-auto md:mx-0">
                <p class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400">Â© 2024 Color Hut Studio. All
                    Rights Reserved.</p>
            </div>
            <div class="flex gap-8">
                <a href="/"
                    class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-orange-500">Home</a>
                <a href="/all"
                    class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-orange-500">Shop</a>
                <a href="/blog"
                    class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-orange-500">Articles</a>
            </div>
        </div>
    </footer>

    <script>
        // Shared Hosting Optimization: Thumbnail detection
        function getThumb(src) {
            if (!src || src.startsWith('blob:') || src.startsWith('data:')) return src;
            if (src.includes('/opt-') && !src.includes('/thumb-')) {
                const parts = src.split('/');
                const filename = parts.pop();
                return parts.join('/') + '/thumb-' + filename;
            }
            return src;
        }

        const intersectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const el = entry.target;
                    const src = el.getAttribute('data-pending-src');
                    if (src) {
                        el.removeAttribute('data-pending-src');
                        const prio = el.getAttribute('data-pending-priority') || 'auto';
                        el.removeAttribute('data-pending-priority');
                        intersectionObserver.unobserve(el);
                        secureMedia(el, src, prio);
                    }
                }
            });
        }, { rootMargin: '600px' });

        async function secureMedia(el, src, priority = 'auto') {
            if (!src || src.startsWith('blob:') || src.startsWith('data:')) return;
            try {
                const response = await fetch(src, { priority });
                const blob = await response.blob();

                if (el.tagName === 'IMG') {
                    const bitmap = await createImageBitmap(blob);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { alpha: false });

                    const maxDim = 800; // Thumbnails mainly
                    let scale = 1;
                    if (bitmap.width > maxDim || bitmap.height > maxDim) {
                        scale = maxDim / Math.max(bitmap.width, bitmap.height);
                    }

                    canvas.width = bitmap.width * scale;
                    canvas.height = bitmap.height * scale;

                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
                    bitmap.close();

                    canvas.id = el.id;
                    canvas.className = el.className;
                    canvas.style.cssText = el.style.cssText;

                    canvas.style.opacity = '0';
                    canvas.style.transition = 'opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1)';

                    const style = window.getComputedStyle(el);
                    canvas.style.width = (style.width && style.width !== '0px' && style.width !== 'auto' && !el.className.includes('w-full')) ? style.width : '100%';
                    canvas.style.height = (style.height && style.height !== '0px' && style.height !== 'auto' && !el.className.includes('h-full')) ? style.height : '100%';
                    canvas.style.objectFit = style.objectFit || 'cover';

                    canvas.setAttribute('data-ghost', 'true');
                    if (el.parentNode) {
                        el.parentNode.classList.add('loaded');
                        el.parentNode.replaceChild(canvas, el);
                    }

                    requestAnimationFrame(() => {
                        canvas.style.opacity = '1';
                    });
                } else if (el.tagName === 'VIDEO') {
                    const blobUrl = URL.createObjectURL(blob);
                    el.src = blobUrl;
                    el.setAttribute('controlsList', 'nodownload');
                    el.oncontextmenu = e => e.preventDefault();
                }
            } catch (e) {
                console.error('SECURE MEDIA ERROR', e);
            }
        }

        const mediaObserver = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) {
                            const targets = node.querySelectorAll('img[data-src]:not([data-ghost]), video[data-src]');
                            if (node.hasAttribute('data-src')) processNode(node);
                            targets.forEach(processNode);
                        }
                    });
                } else if (mutation.type === 'attributes' && mutation.attributeName === 'data-src') {
                    processNode(mutation.target);
                }
            });
        });

        function processNode(el) {
            const s = el.getAttribute('data-src');
            if (s && !el.hasAttribute('data-ghost')) {
                const isEager = el.getAttribute('loading') === 'eager';
                const priority = el.getAttribute('fetchpriority') || 'auto';

                el.removeAttribute('data-src');
                if (isEager) {
                    secureMedia(el, s, priority);
                } else {
                    el.setAttribute('data-pending-src', s);
                    el.setAttribute('data-pending-priority', priority);
                    intersectionObserver.observe(el);
                }
            }
        }

        mediaObserver.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['data-src']
        });

        async function fetchBlogs() {
            try {
                const response = await fetch('/api/public/blogs');
                const data = await response.json();
                if (Array.isArray(data)) {
                    renderBlogs(data);
                } else {
                    console.error('Expected blogs array, but got:', data);
                    renderBlogs([]);
                }
            } catch (err) {
                console.error('Failed to fetch blogs:', err);
                document.getElementById('blog-grid').innerHTML = '<p class="text-center col-span-full py-20 text-slate-400 font-bold uppercase tracking-widest">Unable to load articles.</p>';
            }
        }

        function renderBlogs(blogs) {
            const grid = document.getElementById('blog-grid');
            if (blogs.length === 0) {
                grid.innerHTML = '<p class="text-center col-span-full py-20 text-slate-400 font-bold uppercase tracking-widest text-xs">New perspectives arriving soon.</p>';
                return;
            }

            grid.innerHTML = blogs.map((blog, idx) => `
                <a href="/blog/${blog.slug}" class="group block bg-white rounded-3xl border border-slate-100 overflow-hidden shadow-sm hover:shadow-2xl transition-all duration-500">
                    <div class="aspect-video relative overflow-hidden shimmer-sweep">
                        <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" 
                             data-src="${getThumb(blog.featured_image || blog.image)}" 
                             class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000" 
                             alt="${blog.title}"
                             ${idx < 3 ? 'fetchpriority="high" loading="eager"' : ''}>
                    </div>
                    <div class="p-8">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="px-3 py-1 bg-orange-50 text-orange-600 text-[10px] font-black uppercase tracking-widest rounded-full">${blog.category || 'Luxury'}</span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${new Date(blog.created_at).toLocaleDateString()}</span>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 group-hover:text-orange-500 transition-colors line-clamp-2 leading-snug mb-4">${blog.title}</h3>
                        <p class="text-slate-500 line-clamp-2 text-sm leading-relaxed mb-6">${blog.excerpt || 'Discover the latest in premium design and luxury branding strategy.'}</p>
                        <div class="flex items-center gap-2 text-orange-600 font-bold text-xs uppercase tracking-widest group-hover:gap-4 transition-all">
                            Read Article
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 8l4 4m0 0l-4 4m4-4H3" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </div>
                </a>
            `).join('');
        }

        fetchBlogs();

        // Tracking
        fetch('/api/public/track', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: '/blog', source: document.referrer })
        });
    </script>
    <script>
        // Content Protection: Block image/video save & downloader extensions
        document.addEventListener('contextmenu', e => {
            if (e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO' || e.target.closest('.blog-card')) {
                e.preventDefault();
            }
        });

        // Extension Guard: Periodically clear any injected downloader buttons if any
        setInterval(() => {
            const forbidden = ['download', 'save', 'ext-', 'extension'];
            document.querySelectorAll('div, button, span').forEach(el => {
                const classes = el.className.toString().toLowerCase();
                if (forbidden.some(word => classes.includes(word))) {
                    if (el.style.position === 'absolute' || el.style.position === 'fixed') {
                        el.remove();
                    }
                }
            });
        }, 1000);
    </script>
</body>

</html>