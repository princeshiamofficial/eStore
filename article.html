<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{OG_TITLE}}</title>
    <!-- Social Sharing Meta Tags (Open Graph) -->
    <meta name="description" content="{{OG_DESCRIPTION}}">
    <meta property="og:title" content="{{OG_TITLE}}">
    <meta property="og:description" content="{{OG_DESCRIPTION}}">
    <meta property="og:image" content="{{OG_IMAGE}}">
    <meta property="og:url" content="{{OG_URL}}">
    <meta property="og:type" content="article">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="keywords" content="{{SEO_KEYWORDS}}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #ffffff;
            color: #0f172a;
            scroll-behavior: smooth;
        }

        img,
        video {
            -webkit-user-drag: none;
            user-select: none;
            pointer-events: none;
            /* Block extension detectors */
        }

        .serif-font {
            font-family: 'Instrument Serif', serif;
        }

        .article-content {
            font-size: 18px;
            line-height: 1.8;
            color: #334155;
        }

        .article-content h1,
        .article-content h2,
        .article-content h3 {
            color: #0f172a;
            font-weight: 800;
            margin-top: 2.5rem;
            margin-bottom: 1.25rem;
            letter-spacing: -0.02em;
        }

        .article-content h2 {
            font-size: 2rem;
        }

        .article-content h3 {
            font-size: 1.5rem;
        }

        .article-content p {
            margin-bottom: 1.5rem;
        }

        .article-content blockquote {
            border-left: 4px solid #f97316;
            padding-left: 1.5rem;
            font-style: italic;
            color: #475569;
            margin: 2.5rem 0;
        }

        .article-content img {
            border-radius: 2rem;
            margin: 2.5rem 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        #toc-container {
            position: sticky;
            top: 120px;
        }

        .toc-link {
            transition: all 0.2s;
        }

        .shimmer-sweep {
            position: relative;
            overflow: hidden;
            background: #f1f5f9;
        }

        .shimmer-sweep::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    rgba(255, 255, 255, 0) 100%);
            transform: translateX(-100%);
            animation: shimmer-sweep-anim 1.5s infinite;
        }

        .shimmer-sweep.loaded::after {
            display: none;
        }

        @keyframes shimmer-sweep-anim {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>

<body class="selection:bg-orange-100 selection:text-orange-900">

    <!-- Simple Navigation -->
    <nav
        class="fixed top-0 w-full z-50 bg-white/80 backdrop-blur-md border-b border-slate-100 px-6 md:px-12 py-4 flex items-center justify-between">
        <a href="/" class="flex items-center gap-2">
            <img src="/logo.png" alt="Color Hut" class="h-8">
        </a>
        <div class="hidden md:flex items-center gap-8">
            <a href="/"
                class="text-sm font-bold uppercase tracking-widest text-slate-500 hover:text-orange-500 transition-colors">Home</a>
            <a href="/all"
                class="text-sm font-bold uppercase tracking-widest text-slate-500 hover:text-orange-500 transition-colors">Collections</a>
            <a href="/blog" class="text-sm font-bold uppercase tracking-widest text-orange-600">Blog</a>
        </div>
    </nav>

    <article class="pt-32 pb-24 px-6">
        <header class="max-w-4xl mx-auto text-center mb-16">
            <div class="flex items-center justify-center gap-4 mb-6">
                <span id="article-date"
                    class="text-[10px] font-black uppercase tracking-[0.2em] text-orange-600 bg-orange-50 px-4 py-1.5 rounded-full">Date</span>
                <span id="article-author"
                    class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Author</span>
                <span class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">•</span>
                <span id="read-time" class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">10 Min
                    Read</span>
            </div>
            <h1 id="article-title"
                class="text-4xl md:text-6xl lg:text-7xl font-black text-slate-900 tracking-tighter leading-[0.9] mb-10">
                Loading article...
            </h1>
            <p id="article-excerpt"
                class="text-slate-500 text-lg md:text-xl font-medium max-w-2xl mx-auto leading-relaxed italic opacity-80">
            </p>
        </header>

        <div id="featured-image-container" class="max-w-6xl mx-auto mb-20 shimmer-sweep">
            <img id="featured-image"
                src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="" alt=""
                class="w-full aspect-[21/9] object-cover rounded-[3rem] shadow-2xl shadow-orange-100 hidden"
                fetchpriority="high" loading="eager">
        </div>

        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-[1fr_250px] gap-16 items-start">
            <!-- Article Body -->
            <div class="article-content max-w-3xl lg:ml-auto">
                <div id="content-body">
                    <!-- Content will be injected here -->
                </div>

                <!-- Share Section -->
                <div
                    class="mt-20 pt-10 border-t border-slate-100 flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="text-center md:text-left">
                        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Share
                            Perspective</p>
                        <div class="flex gap-4">
                            <button onclick="share('facebook')"
                                class="p-3 bg-slate-50 hover:bg-orange-50 hover:text-orange-600 rounded-full transition-all">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z" />
                                </svg>
                            </button>
                            <button onclick="share('twitter')"
                                class="p-3 bg-slate-50 hover:bg-orange-50 hover:text-orange-600 rounded-full transition-all">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z" />
                                </svg>
                            </button>
                            <button onclick="copyLink()"
                                class="p-3 bg-slate-50 hover:bg-orange-100 hover:text-orange-600 rounded-full transition-all flex items-center justify-center gap-2 px-6">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <span class="text-[10px] font-black uppercase tracking-widest">Copy Link</span>
                            </button>
                        </div>
                    </div>
                    <div class="md:text-right text-center">
                        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Topic Tags</p>
                        <div id="seo-tags" class="flex flex-wrap gap-2 justify-center md:justify-end">
                            <!-- Tags injected -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table of Contents -->
            <aside id="toc-container" class="hidden lg:block">
                <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-6">On This Page</p>
                <div id="toc-list" class="space-y-4">
                    <!-- TOC injected -->
                </div>

                <div class="mt-16 p-8 bg-orange-50 rounded-[2rem] border border-orange-100">
                    <h4 class="text-sm font-black text-orange-950 uppercase tracking-widest mb-4">Design Consultation
                    </h4>
                    <p class="text-xs text-orange-900/60 font-medium mb-6 leading-relaxed">Let our design studio craft
                        premium assets for your brand's physical presence.</p>
                    <a href="https://wa.me/8801736616654" target="_blank"
                        class="block text-center py-3 bg-white text-orange-600 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-orange-600 hover:text-white transition-all">Get
                        in Touch</a>
                </div>
            </aside>
        </div>
    </article>

    <footer class="bg-slate-50 py-20 px-6 md:px-12 border-t border-slate-100">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-10">
            <div class="text-center md:text-left">
                <img src="/logo.png" alt="Color Hut" class="h-6 mb-4 opacity-50 grayscale mx-auto md:mx-0">
                <p class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400">© 2024 Color Hut Studio. All
                    Rights Reserved.</p>
            </div>
            <div class="flex gap-8">
                <a href="/"
                    class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-orange-500">Home</a>
                <a href="/all"
                    class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-orange-500">Shop</a>
                <a href="/blog"
                    class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-orange-500">Articles</a>
            </div>
        </div>
    </footer>

    <script>
        // Shared Hosting Optimization: Thumbnail detection
        function getThumb(src) {
            if (!src || src.startsWith('blob:') || src.startsWith('data:')) return src;
            if (src.includes('/opt-') && !src.includes('/thumb-')) {
                const parts = src.split('/');
                const filename = parts.pop();
                return parts.join('/') + '/thumb-' + filename;
            }
            return src;
        }

        const intersectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const el = entry.target;
                    const src = el.getAttribute('data-pending-src');
                    if (src) {
                        el.removeAttribute('data-pending-src');
                        const prio = el.getAttribute('data-pending-priority') || 'auto';
                        el.removeAttribute('data-pending-priority');
                        intersectionObserver.unobserve(el);
                        secureMedia(el, src, prio);
                    }
                }
            });
        }, { rootMargin: '600px' });

        async function secureMedia(el, src, priority = 'auto') {
            if (!src || src.startsWith('blob:') || src.startsWith('data:')) return;
            try {
                const response = await fetch(src, { priority });
                const blob = await response.blob();

                if (el.tagName === 'IMG') {
                    const bitmap = await createImageBitmap(blob);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { alpha: false });

                    const maxDim = 1600;
                    let scale = 1;
                    if (bitmap.width > maxDim || bitmap.height > maxDim) {
                        scale = maxDim / Math.max(bitmap.width, bitmap.height);
                    }

                    canvas.width = bitmap.width * scale;
                    canvas.height = bitmap.height * scale;

                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
                    bitmap.close();

                    canvas.id = el.id;
                    canvas.className = el.className;
                    canvas.style.cssText = el.style.cssText;

                    canvas.style.opacity = '0';
                    canvas.style.transition = 'opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1)';

                    const style = window.getComputedStyle(el);
                    canvas.style.width = (style.width && style.width !== '0px' && style.width !== 'auto' && !el.className.includes('w-full')) ? style.width : '100%';
                    canvas.style.height = (style.height && style.height !== '0px' && style.height !== 'auto' && !el.className.includes('h-full')) ? style.height : '100%';
                    canvas.style.objectFit = style.objectFit || 'contain';

                    canvas.setAttribute('data-ghost', 'true');
                    if (el.parentNode) {
                        el.parentNode.classList.add('loaded');
                        el.parentNode.replaceChild(canvas, el);
                    }

                    requestAnimationFrame(() => {
                        canvas.style.opacity = '1';
                    });
                } else if (el.tagName === 'VIDEO') {
                    const blobUrl = URL.createObjectURL(blob);
                    el.src = blobUrl;
                    el.setAttribute('controlsList', 'nodownload');
                    el.oncontextmenu = e => e.preventDefault();
                }
            } catch (e) {
                console.error('SECURE MEDIA ERROR', e);
            }
        }

        const mediaObserver = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) {
                            const targets = node.querySelectorAll('img[data-src]:not([data-ghost]), video[data-src]');
                            if (node.hasAttribute('data-src')) processNode(node);
                            targets.forEach(processNode);
                        }
                    });
                } else if (mutation.type === 'attributes' && mutation.attributeName === 'data-src') {
                    processNode(mutation.target);
                }
            });
        });

        function processNode(el) {
            const s = el.getAttribute('data-src');
            if (s && !el.hasAttribute('data-ghost')) {
                const isEager = el.getAttribute('loading') === 'eager';
                const priority = el.getAttribute('fetchpriority') || 'auto';

                el.removeAttribute('data-src');
                if (isEager) {
                    secureMedia(el, s, priority);
                } else {
                    el.setAttribute('data-pending-src', s);
                    el.setAttribute('data-pending-priority', priority);
                    intersectionObserver.observe(el);
                }
            }
        }

        mediaObserver.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['data-src']
        });

        const slug = window.location.pathname.split('/').pop();

        async function fetchArticle() {
            try {
                const response = await fetch(`/api/public/blogs/${slug}`);
                if (!response.ok) throw new Error('Not found');
                const article = await response.json();
                renderArticle(article);
            } catch (err) {
                console.error('Failed to fetch article:', err);
                document.getElementById('article-title').textContent = 'Perspective Not Found';
            }
        }

        function renderArticle(article) {
            document.title = `${article.title} | Color Hut Studio`;
            document.getElementById('article-title').textContent = article.title;
            document.getElementById('article-date').textContent = new Date(article.created_at).toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('article-author').textContent = `By ${article.author}`;
            document.getElementById('article-excerpt').textContent = article.excerpt || '';

            if (article.featured_image) {
                const img = document.getElementById('featured-image');
                img.src = article.featured_image;
                img.alt = article.title;
                img.classList.remove('hidden');
            }

            // Estimate read time
            const words = article.content.split(/\s+/).length;
            const minutes = Math.ceil(words / 200);
            document.getElementById('read-time').textContent = `${minutes} Min Read`;

            // Content processing (simple Markdown support)
            const contentBody = document.getElementById('content-body');
            let content = article.content;

            // Basic Markdown to HTML
            content = content
                .replace(/^# (.*$)/gm, '<h1 id="$1">$1</h1>')
                .replace(/^## (.*$)/gm, '<h2 id="$1">$1</h2>')
                .replace(/^### (.*$)/gm, '<h3 id="$1">$1</h3>')
                .replace(/^\> (.*$)/gm, '<blockquote>$1</blockquote>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Replace double newlines with paragraphs
            content = content.split('\n\n').map(p => {
                if (p.trim().startsWith('<h') || p.trim().startsWith('<blockquote')) return p;
                return `<p>${p}</p>`;
            }).join('');

            contentBody.innerHTML = content;

            // SEO Tags
            if (article.seo_keywords) {
                const tags = article.seo_keywords.split(',').map(tag => tag.trim());
                document.getElementById('seo-tags').innerHTML = tags.map(tag => `
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-400 bg-slate-50 px-3 py-1 rounded-full">#${tag}</span>
                `).join('');
            }

            generateTOC();
        }

        function generateTOC() {
            const headings = document.getElementById('content-body').querySelectorAll('h2, h3');
            const tocList = document.getElementById('toc-list');

            if (headings.length === 0) {
                document.getElementById('toc-container').classList.add('hidden');
                return;
            }

            tocList.innerHTML = Array.from(headings).map(h => {
                const text = h.textContent;
                const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                h.id = id;
                return `
                    <a href="#${id}" class="toc-link block text-[10px] font-bold uppercase tracking-widest text-slate-400 hover:text-orange-500 ${h.tagName === 'H3' ? 'ml-4' : ''}">${text}</a>
                `;
            }).join('');

            // Scroll SPY logic
            const tocLinks = document.querySelectorAll('.toc-link');
            window.addEventListener('scroll', () => {
                let current = '';
                headings.forEach(h => {
                    const top = h.offsetTop;
                    if (window.pageYOffset >= top - 200) current = h.id;
                });
                tocLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href').substring(1) === current) link.classList.add('active');
                });
            });
        }

        function share(platform) {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.getElementById('article-title').textContent);
            if (platform === 'facebook') window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
            if (platform === 'twitter') window.open(`https://twitter.com/intent/tweet?url=${url}&text=${title}`, '_blank');
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
            alert('Link copied to clipboard!');
        }

        fetchArticle();

        // Tracking
        fetch('/api/public/track', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: window.location.pathname, source: document.referrer })
        });
    </script>
    <script>
        // Content Protection: Block image/video save & downloader extensions
        document.addEventListener('contextmenu', e => {
            if (e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO' || e.target.closest('#featured-image-container')) {
                e.preventDefault();
            }
        });

        // Extension Guard: Periodically clear any injected downloader buttons if any
        setInterval(() => {
            const forbidden = ['download', 'save', 'ext-', 'extension'];
            document.querySelectorAll('div, button, span').forEach(el => {
                const classes = el.className.toString().toLowerCase();
                if (forbidden.some(word => classes.includes(word))) {
                    if (el.style.position === 'absolute' || el.style.position === 'fixed') {
                        el.remove();
                    }
                }
            });
        }, 1000);
    </script>
</body>

</html>